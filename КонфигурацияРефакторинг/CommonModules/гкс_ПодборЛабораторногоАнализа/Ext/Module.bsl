// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Создан общий модуль для централизации логики подбора лабораторного анализа
// Общий модуль для единого механизма подбора лабораторного анализа
// в основания для движения запасов
//
// Функциональность:
// - Централизованная проверка пригодности лабораторного анализа для основания движения запасов
// - Единая логика выбора стратегии подбора анализа (входной контроль / композитные пробы)
// - Заполнение качественных показателей в документе основания движения запасов
// - Перезаполнение основания движения запасов по лабораторному анализу
//
// Автор: GKSTCPLK-1435 Терлецкий АВ
// Дата создания: 15.01.2025
// Задача: Рефакторинг механизма подбора лаб.анализа в основания для движения запасов

#Область ОписаниеПеременных
// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Область для объявления переменных модуля (пустая, переменные не используются)
#КонецОбласти

#Область ПрограммныйИнтерфейс

// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Определяет пригодность лабораторного анализа для основания движения запасов
// Определяет подходящий лабораторный анализ для основания движения запасов
// на основе функциональной опции гкс_ПередаватьКачествоВходногоКонтроля
//
// Параметры:
//  ЛабораторныйАнализ - ДокументСсылка.гкс_ЛабораторныйАнализ - лабораторный анализ для проверки
//
// Возвращаемое значение:
//  Булево - Истина, если документ подходит для заполнения в основание движения запасов
//
Функция ЭтоЛабораторныйАнализДляОснованияДвиженияЗапасов(ЛабораторныйАнализ) Экспорт
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Проверка заполненности параметра
	Если НЕ ЗначениеЗаполнено(ЛабораторныйАнализ) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Получение состояния функциональной опции для выбора стратегии
	ПередаватьКачествоВходногоКонтроля = ПолучитьФункциональнуюОпцию("гкс_ПередаватьКачествоВходногоКонтроля");
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Получение назначения использования качества из лабораторного анализа
	НазначениеИспользованияКачества = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
			ЛабораторныйАнализ, "гкс_НазначениеИспользованияКачества");
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Логика выбора анализа для композитных проб (опция выключена)
	Если НЕ ПередаватьКачествоВходногоКонтроля
		И НазначениеИспользованияКачества = Перечисления.гкс_НазначенияИспользованияКачества.ПриемкаКомпозит Тогда
		
		Возврат Истина;
		
		// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Логика выбора анализа для входного контроля (опция включена)
	ИначеЕсли ПередаватьКачествоВходногоКонтроля
		И НазначениеИспользованияКачества = Перечисления.гкс_НазначенияИспользованияКачества.Приемка Тогда
		
		Возврат Истина;
		
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Возвращает текст запроса в зависимости от функциональной опции
// Возвращает текст запроса для подбора лабораторного анализа
// в зависимости от функциональной опции гкс_ПередаватьКачествоВходногоКонтроля
//
// Возвращаемое значение:
//  Строка - текст запроса для подбора лабораторного анализа
//
Функция ПолучитьТекстЗапросаДляПодбораЛабораторногоАнализа() Экспорт
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Применение паттерна "Стратегия" для выбора алгоритма подбора
	ПередаватьКачествоВходногоКонтроля = ПолучитьФункциональнуюОпцию("гкс_ПередаватьКачествоВходногоКонтроля");
	
	Если ПередаватьКачествоВходногоКонтроля Тогда
		Возврат ПолучитьТекстЗапросаДляВходногоКонтроля();
	Иначе
		Возврат ПолучитьТекстЗапросаДляКомпозитныхПроб();
	КонецЕсли;
	
КонецФункции

// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Заполняет качественные показатели в документе основания движения запасов
// Заполняет качественные показатели в основании для движения запасов
// на основе лабораторного анализа
//
// Параметры:
//  ОснованиеДвиженияЗапасов - ДокументОбъект.гкс_ОснованиеДляДвиженияЗапасов - документ для заполнения
//  ЛабораторныйАнализ - ДокументСсылка.гкс_ЛабораторныйАнализ - источник качественных показателей
//
Процедура ЗаполнитьКачественныеПоказателиПоЛабораторномуАнализу(ОснованиеДвиженияЗапасов, ЛабораторныйАнализ) Экспорт
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Валидация входных параметров
	Если НЕ ЗначениеЗаполнено(ЛабораторныйАнализ) Тогда
		Возврат;
	КонецЕсли;
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Проверка пригодности анализа через единую функцию
	Если НЕ ЭтоЛабораторныйАнализДляОснованияДвиженияЗапасов(ЛабораторныйАнализ) Тогда
		Возврат;
	КонецЕсли;
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Очистка существующих показателей перед заполнением
	ОснованиеДвиженияЗапасов.КачественныеПоказатели.Очистить();
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Запрос для получения качественных показателей из лабораторного анализа
	ЗапросПоказатели = Новый Запрос;
	ЗапросПоказатели.Текст =
		"ВЫБРАТЬ
		|    КачественныеПоказатели.НомерСтроки,
		|    КачественныеПоказатели.Показатель,
		|    КачественныеПоказатели.Значение,
		|    КачественныеПоказатели.ЕдиницаИзмерения
		|ИЗ
		|    Документ.гкс_ЛабораторныйАнализ.КачественныеПоказатели КАК КачественныеПоказатели
		|ГДЕ
		|    КачественныеПоказатели.Ссылка = &ЛабораторныйАнализ
		|
		|УПОРЯДОЧИТЬ ПО
		|    КачественныеПоказатели.НомерСтроки";
	
	ЗапросПоказатели.УстановитьПараметр("ЛабораторныйАнализ", ЛабораторныйАнализ);
	
	РезультатЗапроса = ЗапросПоказатели.Выполнить();
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Заполнение табличной части показателями из анализа
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		ВыборкаПоказатели = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаПоказатели.Следующий() Цикл
			
			НоваяСтрока = ОснованиеДвиженияЗапасов.КачественныеПоказатели.Добавить();
			НоваяСтрока.Показатель = ВыборкаПоказатели.Показатель;
			НоваяСтрока.Значение = ВыборкаПоказатели.Значение;
			НоваяСтрока.ЕдиницаИзмерения = ВыборкаПоказатели.ЕдиницаИзмерения;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Перезаполняет документ основания движения запасов по стратегии
// Перезаполняет основание для движения запасов по лабораторному анализу
// в зависимости от функциональной опции гкс_ПередаватьКачествоВходногоКонтроля
//
// Параметры:
//  ОснованиеДвиженияЗапасов - ДокументОбъект.гкс_ОснованиеДляДвиженияЗапасов - документ для перезаполнения
//  ПараметрыПерезаполнения - Структура - дополнительные параметры перезаполнения (номенклатура, склад, период)
//
Процедура ПерезаполнитьОснованиеДвиженияЗапасовПоЛабораторномуАнализу(ОснованиеДвиженияЗапасов, ПараметрыПерезаполнения = Неопределено) Экспорт
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Выбор стратегии перезаполнения по функциональной опции
	ПередаватьКачествоВходногоКонтроля = ПолучитьФункциональнуюОпцию("гкс_ПередаватьКачествоВходногоКонтроля");
	
	Если ПередаватьКачествоВходногоКонтроля Тогда
		ПерезаполнитьПоВходномуКонтролю(ОснованиеДвиженияЗапасов, ПараметрыПерезаполнения);
	Иначе
		ПерезаполнитьПоКомпозитнымПробам(ОснованиеДвиженияЗапасов, ПараметрыПерезаполнения);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Возвращает текст запроса для стратегии входного контроля
// Возвращает текст запроса для подбора лабораторного анализа
// по входному контролю (назначение использования "Приемка")
//
// Возвращаемое значение:
//  Строка - текст запроса для входного контроля
//
Функция ПолучитьТекстЗапросаДляВходногоКонтроля()
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Запрос для подбора проведенных анализов с назначением "Приемка"
	Возврат
	"ВЫБРАТЬ
	|    ЛабораторныйАнализ.Ссылка КАК АнализСсылка,
	|    ЛабораторныйАнализ.Дата КАК ДатаАнализа,
	|    ЛабораторныйАнализ.Номер КАК НомерАнализа
	|ИЗ
	|    Документ.гкс_ЛабораторныйАнализ КАК ЛабораторныйАнализ
	|ГДЕ
	|    ЛабораторныйАнализ.Проведен
	|    И ЛабораторныйАнализ.гкс_НазначениеИспользованияКачества = ЗНАЧЕНИЕ(Перечисление.гкс_НазначенияИспользованияКачества.Приемка)
	|
	|УПОРЯДОЧИТЬ ПО
	|    ЛабораторныйАнализ.Дата УБЫВ,
	|    ЛабораторныйАнализ.Номер УБЫВ";
	
КонецФункции

// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Возвращает текст запроса для стратегии композитных проб
// Возвращает текст запроса для подбора лабораторного анализа
// по композитным пробам (назначение использования "ПриемкаКомпозит")
//
// Возвращаемое значение:
//  Строка - текст запроса для композитных проб
//
Функция ПолучитьТекстЗапросаДляКомпозитныхПроб()
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Запрос с соединением через документ формирования номера пробы
	Возврат
	"ВЫБРАТЬ
	|    ЛабораторныйАнализ.Ссылка КАК АнализСсылка,
	|    ЛабораторныйАнализ.Дата КАК ДатаАнализа,
	|    ЛабораторныйАнализ.Номер КАК НомерАнализа
	|ПОМЕСТИТЬ ВТ_ПоФормированиюПроб
	|ИЗ
	|    Документ.гкс_ФормированиеНомераПробы.СписокРегистраций КАК ФормированиеНомераПробыСписокРегистраций
	|        ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.гкс_ЛабораторныйАнализ КАК ЛабораторныйАнализ
	|        ПО ФормированиеНомераПробыСписокРегистраций.Ссылка = ЛабораторныйАнализ.гкс_ДокументРегистрации
	|            И (ЛабораторныйАнализ.Проведен)
	|            И (ЛабораторныйАнализ.гкс_НазначениеИспользованияКачества = ЗНАЧЕНИЕ(Перечисление.гкс_НазначенияИспользованияКачества.ПриемкаКомпозит))
	|
	|УПОРЯДОЧИТЬ ПО
	|    ЛабораторныйАнализ.Дата УБЫВ,
	|    ЛабораторныйАнализ.Номер УБЫВ";
	
КонецФункции

// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Выполняет перезаполнение по стратегии входного контроля
// Перезаполняет основание для движения запасов по входному контролю
// (поиск лабораторного анализа с назначением "Приемка")
//
// Параметры:
//  ОснованиеДвиженияЗапасов - ДокументОбъект.гкс_ОснованиеДляДвиженияЗапасов - документ для перезаполнения
//  ПараметрыПерезаполнения - Структура - дополнительные параметры перезаполнения
//
Процедура ПерезаполнитьПоВходномуКонтролю(ОснованиеДвиженияЗапасов, ПараметрыПерезаполнения)
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Создание запроса для поиска подходящего анализа входного контроля
	ЗапросАнализ = Новый Запрос;
	ЗапросАнализ.Текст = ПолучитьТекстЗапросаДляВходногоКонтроля();
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Дополнение запроса условиями из параметров
	Если ПараметрыПерезаполнения <> Неопределено Тогда
		ДополнитьЗапросУсловиями(ЗапросАнализ, ПараметрыПерезаполнения);
	КонецЕсли;
	
	РезультатЗапроса = ЗапросАнализ.Выполнить();
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Заполнение показателей из первого найденного анализа
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		ВыборкаАнализ = РезультатЗапроса.Выбрать();
		
		Если ВыборкаАнализ.Следующий() Тогда
			ЗаполнитьКачественныеПоказателиПоЛабораторномуАнализу(ОснованиеДвиженияЗапасов, ВыборкаАнализ.АнализСсылка);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Выполняет перезаполнение по стратегии композитных проб
// Перезаполняет основание для движения запасов по композитным пробам
// (поиск лабораторного анализа с назначением "ПриемкаКомпозит")
//
// Параметры:
//  ОснованиеДвиженияЗапасов - ДокументОбъект.гкс_ОснованиеДляДвиженияЗапасов - документ для перезаполнения
//  ПараметрыПерезаполнения - Структура - дополнительные параметры перезаполнения
//
Процедура ПерезаполнитьПоКомпозитнымПробам(ОснованиеДвиженияЗапасов, ПараметрыПерезаполнения)
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Создание запроса для поиска подходящего анализа композитных проб
	ЗапросАнализ = Новый Запрос;
	ЗапросАнализ.Текст = ПолучитьТекстЗапросаДляКомпозитныхПроб();
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Дополнение запроса условиями из параметров
	Если ПараметрыПерезаполнения <> Неопределено Тогда
		ДополнитьЗапросУсловиями(ЗапросАнализ, ПараметрыПерезаполнения);
	КонецЕсли;
	
	РезультатЗапроса = ЗапросАнализ.Выполнить();
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Заполнение показателей из первого найденного анализа
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		ВыборкаАнализ = РезультатЗапроса.Выбрать();
		
		Если ВыборкаАнализ.Следующий() Тогда
			ЗаполнитьКачественныеПоказателиПоЛабораторномуАнализу(ОснованиеДвиженияЗапасов, ВыборкаАнализ.АнализСсылка);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Добавляет дополнительные условия отбора в запрос
// Дополняет запрос дополнительными условиями отбора
// (номенклатура, склад, период дат)
//
// Параметры:
//  Запрос - Запрос - запрос для дополнения
//  ПараметрыПерезаполнения - Структура - параметры для дополнения запроса
//
Процедура ДополнитьЗапросУсловиями(Запрос, ПараметрыПерезаполнения)
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Добавление условия по номенклатуре
	Если ПараметрыПерезаполнения.Свойство("Номенклатура") И ЗначениеЗаполнено(ПараметрыПерезаполнения.Номенклатура) Тогда
		Запрос.УстановитьПараметр("Номенклатура", ПараметрыПерезаполнения.Номенклатура);
	КонецЕсли;
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Добавление условия по складу
	Если ПараметрыПерезаполнения.Свойство("Склад") И ЗначениеЗаполнено(ПараметрыПерезаполнения.Склад) Тогда
		Запрос.УстановитьПараметр("Склад", ПараметрыПерезаполнения.Склад);
	КонецЕсли;
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Добавление условия по начальной дате периода
	Если ПараметрыПерезаполнения.Свойство("ДатаС") И ЗначениеЗаполнено(ПараметрыПерезаполнения.ДатаС) Тогда
		Запрос.УстановитьПараметр("ДатаС", ПараметрыПерезаполнения.ДатаС);
	КонецЕсли;
	
	// Гкс+[GKSTCPLK-1435] Терлецкий АВ 15.01.2025 Добавление условия по конечной дате периода
	Если ПараметрыПерезаполнения.Свойство("ДатаПо") И ЗначениеЗаполнено(ПараметрыПерезаполнения.ДатаПо) Тогда
		Запрос.УстановитьПараметр("ДатаПо", ПараметрыПерезаполнения.ДатаПо);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти