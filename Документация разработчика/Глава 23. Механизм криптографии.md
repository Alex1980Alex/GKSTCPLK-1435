Глава 23. Механизм криптографии

23.1. Общая информация

23.2. Основные понятия

23.3. Общая схема использования механизмов криптографии

23.3.1. Общая информация

При использовании системы «1С:Предприятие» в системах автоматизации может быть необходимо обеспечить проверку, что тот или иной документ, хранящийся в системе, не был изменен (например, к объекту базы данных Договор прикладывается документ, содержащий текст самого договора). Также может возникать необходимость обеспечить передачу какой-либо подписанной информации или организовать утверждение какого-либо документа в рамках системы. Возможны ситуации, когда требуется обеспечить передачу информации по открытым каналам так, чтобы с ней было невозможно ознакомиться, перехватив передачу (зашифровать данные).

Для подобных ситуаций в системе «1С:Предприятие» реализован механизм криптографии, базирующийся на асимметричном шифровании (используется пара ключей ‑ открытый и закрытый).

ВНИМАНИЕ! Механизм криптографии «1С:Предприятия» не содержит реализации собственно алгоритмов криптографии. Он обеспечивает набор объектов, позволяющих взаимодействовать с внешними модулями криптографии сторонних производителей.

Открытый ключ предназначен для передачи по открытым каналам. Закрытый ключ для распространения не предназначен и должен быть максимально защищен (секретный ключ).

Чтобы зашифровать данные, необходимо знать открытые ключи получателей. Для расшифровки нужно иметь закрытый ключ, являющийся парой для открытого, указанного при осуществлении шифрования. Для генерации цифровой подписи нужен закрытый ключ, а для проверки подписи ‑ открытый ключ подписавшего (чаще всего открытый ключ включен в саму подпись).

При шифровании данных, кроме асимметричного шифрования, используется симметричное шифрование. Симметричное шифрование ‑ это способ шифрования, когда для шифрования и расшифровки используется один и тот же ключ. Особенности применения симметричного шифрования будут описаны далее в разделе.

При работе с механизмом криптографии следует учитывать, где выполняется эта работа. Причина заключается в том, что схемы работы с криптографией на стороне клиентского приложения и на стороне сервера существенно отличаются. На стороне сервера используются так называемые синхронные методы работы с криптографией, в то время как на стороне клиентского приложения используются асинхронные методы работы.

Для работы в веб-клиенте должно быть установлено расширение работы с криптографией. Особенностью веб-клиента является выполнение запроса разрешения пользователя на выполнение некоторых операций: доступ к файловой системе и к закрытому ключу.

При описании механизмов будут использоваться некоторые термины.

Электронная цифровая подпись (далее ‑ ЭЦП) ‑ последовательность данных, полученная в результате криптографического преобразования исходной информации с использованием закрытого ключа ЭЦП. Позволяет подтверждать целостность и неизменность этой информации, а также ее авторство при условии использования открытого ключа ЭЦП и его сертификата. ЭЦП может быть присоединенная (прикрепленная) и отсоединенная (открепленная). В случае присоединенной ЭЦП и подпись и подписанные данные располагаются в одном файле. В случае отсоединенной ЭЦП файл данных остается неизменным, а ЭЦП располагается в отдельном файле.

Центр по удостоверению подлинности электронной цифровой подписи (далее ‑ Удостоверяющий центр или УЦ) ‑ юридическое лицо или выделенное подразделение юридического лица, обладающее правомочиями на удостоверение принадлежности конкретного открытого ключа ЭЦП определенному пользователю. Сертификаты, необходимые для выполнения криптографических операций, выпускаются УЦ.

Сертификат открытого ключа (или сертификат) ‑ электронный документ, включающий открытый ключ и информацию о владельце данного ключа, заверенную с помощью ЭЦП удостоверяющим центром.

Контейнер ключа ‑ хранилище, в котором содержится закрытый ключ, а также может находиться и открытый ключ (парный к этому закрытому). Доступ к содержимому контейнера защищается паролем или каким-либо другим средством.

Владелец сертификата ключа ‑ физическое лицо, на имя которого удостоверяющим центром изготовлен сертификат открытого ключа и которое владеет соответствующим закрытым (секретным) ключом.

Модуль криптографии ‑ библиотека функций, в которой реализованы непосредственно криптографические алгоритмы или через которую осуществляется доступ к механизмам шифрования.

Метка доверенного времени ‑ достоверная информация в электронной форме о дате и времени подписания электронного документа электронной подписью. Метка доверенного времени создается и проверяется доверенной третьей стороной, удостоверяющим центром или оператором информационной системы. Эта метка получается в момент подписания электронного документа электронной подписью в установленном порядке с использованием программных и/ или аппаратных средств.

При работе с криптографическими механизмами можно выделить два основных варианта использования:

23.3.2. Шифрование/расшифровка

23.3.3. Подпись/проверка подписи

При работе с объектом МенеджерКриптографии не рекомендуется получать несколько хранилищ сертификатов с одинаковыми характеристиками, поскольку модификация одного хранилища может привести к разному поведению другого, в зависимости от используемых модулей криптографии.

Если при использовании механизмов криптографии необходимо явно указать алгоритм, который будет использоваться при шифровании, хешировании или формировании подписи, то рекомендуется указывать эти алгоритмы не в мнемонической (аббревиатурной) нотации, а в виде идентификатора объекта (OID). Это связано с тем, что один и тот же алгоритм может по-разному описываться разными провайдерами, но при этом это все равно будет алгоритм с конкретным, уникальным OID. Так, алгоритм формирования подписи SHA-256 имеет OID 2.16.840.1.101.3.4.2.1, а криптографический алгоритм с открытым ключом RSA имеет OID 1.2.840.113549.1.1.1. Получить информацию по OID можно на сайте https://oidref.com/ (на английском языке).

В следующих разделах будут более подробно рассмотрены различные варианты использования механизма криптографии.

Общая схема работы при шифровании/расшифровке выглядит следующим образом:

1. Создается необходимый объект доступа к криптографической функциональности (объект МенеджерКриптографии).

2. Выбирается необходимый сертификат, который является открытым ключом принимающей стороны (объект СертификатКриптографии). С помощью этого сертификата будет выполняться шифрование данных.

3. Выполняется шифрование необходимого файла или двоичных данных с помощью методов Зашифровать() созданного объекта типа МенеджерКриптографии.

В процессе шифрования используется комбинация симметричного и асимметричного шифрования. Вначале система формирует ключ для симметричного шифрования, затем этим ключом выполняется шифрование требуемых данных. Затем ключ симметричного шифрования шифруется асимметричным ключом. Пакет данных, пригодный для передачи по открытым каналам, формируется из трех составляющих: зашифрованные данные, зашифрованный ключ для симметричного шифрования и список получателей. Пакет данных формируется по спецификации CMS (базируется на PKCS#7).

4. Зашифрованные данные готовы для передачи по открытым каналам.

5. При получении зашифрованных данных выполняется обратная операция.

6. Создается необходимый объект доступа к криптографической функциональности. Модуль криптографии, связанный с объектом, должен поддерживает работу с алгоритмами, которые использованы для шифрования данных.

7. Выполняется расшифровка полученных данных с помощью метода Расшифровать() созданного объекта доступа к криптографической функциональности.

При расшифровке из пришедшего пакета извлекается зашифрованный ключ для симметричного шифрования и расшифровывается с использованием закрытого ключа (парный к открытому ключу, который использовался для шифрования). Затем полученный ключ используется в симметричном алгоритме для расшифровки массива полученных данных. Таким образом, если принимающая сторона («из» асимметричного шифрования) не имеет закрытого ключа, будет невозможно расшифровать данные симметричным алгоритмом.

Общая схема работы при подписи/проверке подписи выглядит следующим образом:

1. Создается необходимый объект доступа к криптографической функциональности (объект МенеджерКриптографии).

2. Выбирается необходимый сертификат, связанный с закрытым ключом подписывающей стороны (объект СертификатКриптографии). С помощью этого сертификата будет выполняться формирование ЭЦП.

3. Выбирается используемый вариант ЭЦП с помощью свойства ВключениеДанныхВПодпись созданного объекта МенеджерКриптографии:

•

Истина ‑ будет формироваться присоединенная ЭЦП.

•

Ложь ‑ будет формироваться отсоединенная ЭЦП (значение по умолчанию).

Действия при работе с ЭЦП будут несколько различаться в зависимости от выбранного варианта ЭЦП.

4. Выполняется формирование ЭЦП необходимого файла или двоичных данных с помощью методов Подписать() созданного объекта типа МенеджерКриптографии.

При формировании подписи следует учитывать следующие особенности: вначале формируется хеш-сумма подписываемых данных и затем выполняется подпись полученной хеш-суммы. Это сделано для того, чтобы уменьшить время, необходимое для выполнения операции подписи данных.

В силу этого рекомендуется явным образом указывать алгоритмы, которые будут использоваться как для вычисления хеш-суммы (свойство АлгоритмХеширования), так и для выполнения подписи (свойство АлгоритмПодписи). Если принимающая сторона не будет поддерживать используемые алгоритмы (хеширования и подписи), то проверить подпись будет невозможно.

23.4. Работа с модулями криптографии

23.5. Примеры использования

23.5.1. Общая информация

23.5.2. Создание объекта доступа к криптографическому функционалу

Копировать в буфер обмена

содержать список алгоритмов, которые поддерживает используемый модуль криптографии. В свойства менеджера криптографии следует указывать те данные, которые содержатся в свойствах объекта ИнформацияМодуляКриптографии.

Информация об используемых алгоритмах будет содержаться в подписи, поэтому нет необходимости дополнительно передавать ее вместе с подписанными данными.

5. Подписанные данные передаются принимаемой стороне. В зависимости от выбранного варианта ЭЦП это будет один файл (присоединенная ЭЦП) или два файла (отсоединенная ЭЦП: сами данные и файл ЭЦП).

6. После получения подписанных данных выполняется обратная операция.

7. Создается необходимый объект доступа к криптографической функциональности. Модуль криптографии, связанный с объектом, должен поддерживает работу с алгоритмами, которые использованы для формирования ЭЦП.

8. Выполняется проверка электронной подписи с помощью метода ПроверитьПодпись() созданного объекта доступа к криптографическому функционалу. Если модуль криптографии, используемый для проверки подписи, не поддерживает алгоритм, используемые для вычисления хеш-суммы и подписи данных, то проверить подпись будет невозможно и будет выдана ошибка.

Система «1С:Предприятие» позволяет формировать электронную подпись в форматах CAdES (с различными вариантами) и CMS (устаревший вариант). Для указания типа электронной подписи служит параметр ТипПодписи метода Подписать(). По умолчанию подпись выполняется в формате CAdES-BES. Каждый следующий формат (кроме CMS) является расширением предыдущего формата, т. е. CAdES-T является расширением формата CAdES-BES, CAdES-C является расширением CAdES-T и т. д. Допустимы следующие варианты подписи:

•

CAdES-BES (CAdESBES) ‑ основной формат электронной подписи стандарта CAdES (значение по умолчанию).

•

CAdES-T (CAdEST) ‑ формат электронной подписи с доверенным временем.

•

CAdES-C (CAdESC) ‑ формат электронной подписи с полным набором проверочных данных.

•

CAdES-X Long Type 2 (CAdESXLongType2) ‑ формат долгосрочной расширенной подписи с несколькими расширениями.

•

CAdES-A v3 (CAdESAv3) ‑ формат электронной подписи для архивного хранения.

•

CMS (CMS) ‑ устаревший формат электронной подписи.

Если необходимо передать подписанный документ на архивное хранение, то для этого необходимо выполнить следующие действия:

•

Подписать документ с помощью электронной подписи формата CAdES-A, который предназначен для архивного хранения. Если этого не было выполнено, то необходимо усовершенствовать существующую подпись с помощью метода УсовершенствоватьПодпись().

•

Если документ подписан подписью в формате CMS, то усовершенствовать такую подпись невозможно. Документ надо переподписать подписью формата CAdES-A.

•

После помещения документа в архив, необходимо с некоторой периодичностью (рекомендуется 1 раз в год) выполнять добавление в существующую подпись архивной метки времени с помощью метода ДобавитьАрхивнуюМеткуВремени(). Для того, чтобы платформа могла получить доверенную метку времени, необходимо задать сервера меток времени. Для этого служит свойство АдресаСерверовМетокВремени менеджера криптографии. Например, в качестве сервера меток времени может выступать сервер фирмы «1С» https://1stdss.1c.ru/TSP/tsp.srf или любой другой доступный сервер.

При проверке электронной подписи может потребоваться выполнять проверку установленных меток времени. Для этого следует использовать метод ПроверитьМеткуВремени().

Для взаимодействия с модулями криптографии в ОС Windows используется Microsoft CryptoAPI, а при работе в ОС Linux или macOS ‑ интерфейс КриптоПРО CSP.

Список поддерживаемых компонент:

•

Средство криптографической защиты информации КриптоПро. Для использования данного средства следует в качестве параметра ТипМодуляКриптографии конструктора объекта МенеджерКриптографии указать значение 80.

В данном разделе приводятся примеры реализация некоторых типовых задач при использовании механизма криптографии.

Создание объекта доступа к криптографическому функционалу является базовой операцией, без выполнения которой невозможны дальнейшие операции с механизмом криптографии.

Копировать в буфер обмена ДляИнициализации = Новый МенеджерКриптографии(); Обещание = ДляИнициализации.ИнициализироватьАсинх(ИспользованиеИнтерактивногоРежимаКриптографии.Использовать); МенеджерКриптографии = Ждать Обещание;

23.5.3. Получение списка сертификатов

Копировать в буфер обмена Асинх Функция ПолучитьСписокСертификатов(ТипМенеджераКриптографии, МассивТипов, ПроверятьДатуОкончания) СписокСертификатов = Новый Массив; МенеджерКриптографии = Новый МенеджерКриптографии("", "", ТипМенеджераКриптографии); Для Каждого ТипХранилища Из МассивТипов Цикл // Получаем сертификаты для каждого типа хранилища сертификатов Хранилище = Ждать МенеджерКриптографии.ПолучитьХранилищеСертификатовАсинх(ТипХранилища); // Выбираем все сертификаты СертификатыХранилища = Ждать Хранилище.ПолучитьВсеАсинх(); ТекущаяДата = ТекущаяДата(); Для Каждого Сертификат Из СертификатыХранилища Цикл // Проверим, что дата окончания сертификата еще не наступила Если ПроверятьДатуОкончания И Сертификат.ДатаОкончания < ТекущаяДата Тогда Продолжить; КонецЕсли; СписокСертификатов.Добавить(Сертификат); КонецЦикла; КонецЦикла; Возврат СписокСертификатов; КонецФункции &НаКлиенте Асинх Процедура ВыполнитьКоманду(Команда) ТипыХранилищ = Новый Массив; ТипыХранилищ.Добавить(ТипХранилищаСертификатовКриптографии.ПерсональныеСертификаты); ТипыХранилищ.Добавить(ТипХранилищаСертификатовКриптографии.СертификатыПолучателей); Список = Ждать ПолучитьСписокСертификатов(80, ТипыХранилищ, Истина); // … КонецПроцедуры

23.5.4. Шифрование файла

Копировать в буфер обмена &НаСервере Функция ЗашифроватьНаСервере(АдресДанных, ДанныеСертификатов) // Создадим сертификаты на основании двоичных данных сертификатов с клиента Сертификаты = Новый Массив(); Для Каждого ДанныеСертификата Из ДанныеСертификатов Цикл Сертификаты.Добавить(Новый СертификатКриптографии(ДанныеСертификата)); КонецЦикла; МенеджерКриптографии = Новый МенеджерКриптографии("", "", 80); // Получим файл для шифрования из временного хранилища Данные = ПолучитьИзВременногоХранилища(АдресДанных); Если ТипЗнч(Данные) <> Тип("ДвоичныеДанные") Тогда Возврат Ложь; КонецЕсли; // Шифруем двоичные данные ЗашифрованныеДвоичныеДанные = МенеджерКриптографии.Зашифровать(Данные, Сертификаты); // Сохраняем во временное хранилище АдресДанных = ПоместитьВоВременноеХранилище(ЗашифрованныеДвоичныеДанные);

ТипМодуляКриптографии равен 80).

При работе под управлением ОС Linux или macOS используется следующий алгоритм для определения расположения модуля КриптоПРО CSP:

•

Если в конструкторе менеджера криптографии указан параметр ПутьМодуляКриптографии ‑ выполняется попытка использования модуля, указанного в качестве значения параметра.

•

Если в конструкторе менеджера криптографии не указан параметр ПутьМодуляКриптографии, то выполняется попытка найти модуль криптографии в тех каталогах компьютера, которые указаны с помощью параметра CryptoAPILibraryLocation файла conf.cfg.

•

Если параметр CryptoAPILibraryLocation отсутствует в файле conf.cfg ‑ выполняется попытка поиска модуля КриптоПРО по стандартным путям расположения модуля.

Если параметры модуля криптографии неизвестны, то можно воспользоваться простым вариантом создания менеджера криптографии:

Формируется список сертификатов из выбранных хранилищ сертификатов для дальнейшей работы с этим списком.

Выполняется шифрование интерактивно выбранного файла и интерактивная запись зашифрованного файла на диск клиентского компьютера.

В целях демонстрации для операции шифрования всегда используется первый по списку сертификат из всех сертификатов, установленных на компьютере.

&НаКлиенте Асинх Процедура ВыполнитьКоманду(Команда) ПомещенныйФайл = Ждать ПоместитьФайлНаСерверАсинх(, , , Новый ПараметрыДиалогаПомещенияФайлов); Если ПомещенныйФайл = Неопределено Тогда Возврат; КонецЕсли; Адрес = ПомещенныйФайл.Адрес; ТипыСертификатов = Новый Массив; ТипыСертификатов.Добавить(ТипХранилищаСертификатовКриптографии.ПерсональныеСертификаты); Список = Ждать ПолучитьСписокСертификатов(80, ТипыСертификатов, Истина); // В примере всегда шифруем с помощью первого по порядку сертификата // В реальной жизни это может не сработать и // надо выбирать сертификат по другим критериям Сертификаты = Новый Массив; Сертификаты.Добавить(Ждать Список[0].ВыгрузитьАсинх()); // Шифруем файл РезультатШифрования = ЗашифроватьНаСервере(Адрес, Сертификаты); Если Не РезультатШифрования Тогда Возврат; КонецЕсли; // Интерактивно сохраняем зашифрованный файл на диск ПолучитьФайлССервераАсинх(Адрес, ПомещенныйФайл.СсылкаНаФайл.Файл.ПолноеИмя + ".signed", Новый ПараметрыДиалогаПолученияФайлов); КонецПроцедуры

23.5.5. Расшифровка файла

Копировать в буфер обмена &НаКлиенте Асинх Процедура РасшифровкаФайла() // Выбрать зашифрованный файл ПомещенныйФайл = Ждать ПоместитьФайлНаСерверАсинх(, , , Новый ПараметрыДиалогаПомещенияФайлов); Если ПомещенныйФайл = Неопределено Тогда Возврат; КонецЕсли; Данные = ПолучитьИзВременногоХранилища(ПомещенныйФайл.Адрес); // Расшифровать файл МенеджерКриптографии = Новый МенеджерКриптографии("", "", 80); МенеджерКриптографии.ПарольДоступаКЗакрытомуКлючу = ПолучитьПарольДоступа(); РасшифрованныеДанные = Ждать МенеджерКриптографии.РасшифроватьАсинх(Данные); Адрес = ПоместитьВоВременноеХранилище(РасшифрованныеДанные); ПолучитьФайлССервераАсинх(Адрес, , Новый ПараметрыДиалогаПолученияФайлов); КонецПроцедуры

23.5.6. Формирование ЭЦП

Копировать в буфер обмена &НаКлиенте Асинх Функция ПодписатьФайл(ПрисоединеннаяПодпись) // Выбрать подписываемый файл ПомещенныйФайл = Ждать ПоместитьФайлНаСерверАсинх(, , , Новый ПараметрыДиалогаПомещенияФайлов); Если ПомещенныйФайл = Неопределено Тогда Возврат Неопределено; КонецЕсли; Данные = ПолучитьИзВременногоХранилища(ПомещенныйФайл.Адрес); // Сформировать файл подписи ТипыСертификатов = Новый Массив; ТипыСертификатов.Добавить(ТипХранилищаСертификатовКриптографии.ПерсональныеСертификаты); Список = Ждать ПолучитьСписокСертификатов(80, ТипыСертификатов, Истина); // В примере всегда шифруем с помощью первого по порядку сертификата // В реальной жизни это может не сработать и // надо выбирать сертификат по другим критериям Сертификат = Список[0]; Данные = ПолучитьИзВременногоХранилища(ПомещенныйФайл.Адрес); МенеджерКриптографии = Новый МенеджерКриптографии("", "", 80);

Выполняется попытка расшифровки выбранного файла. Необходима реализация функции ПолучитьПарольДоступа(), которая возвращает значение пароля доступа к закрытому ключу.

ПРИМЕЧАНИЕ. При использовании метода Расшифровать() исключение будет вызвано только после того, как неудачно завершились попытки расшифровки с помощью всех доступных сертификатов, а не после первой ошибки.

Подписывается ЭЦП выбранный файл. Вариант подписи определяется параметром ПрисоединеннаяПодпись метода ПодписатьФайл(). Если параметр ПрисоединеннаяПодпись установлен в значение Истина, то будет формироваться присоединенная ЭЦП и в этом случае ЭЦП с включенными данными будет записана в файл, имя которого совпадает с именем выбранного файла, а расширение ‑ .sign. Если параметр ПрисоединеннаяПодпись установлен в значение Ложь, то будет сформирована отсоединенная ЭЦП. ЭЦП всегда сохраняется в файл signature.sign. Необходима реализация функций:

•

ПолучитьПарольДоступа() ‑ возвращает значение пароля доступа к закрытому ключу.

•

ПолучитьСписокСертификатов() ‑ возвращает массив сертификатов, которые могут использоваться для формирования ЭЦП.

МенеджерКриптографии.ВключениеДанныхВПодпись = ПрисоединеннаяПодпись; Если ПрисоединеннаяПодпись Тогда ИмяФайла = Ждать МенеджерКриптографии.ПодписатьАсинх(Данные, ФайлДляПодписи.Путь + ФайлДляПодписи.ИмяБезРасширения + ".sign", Сертификат); Иначе ИмяФайла = Ждать МенеджерКриптографии.ПодписатьАсинх(Данные, ФайлДляПодписи.Путь + "signature.sign", Сертификат); КонецЕсли; КонецФункции

23.5.7. Проверка ЭЦП

Копировать в буфер обмена &НаКлиенте Асинх Функция ПроверитьПодписьФайла() // Выбрать подписанный файл ПроверяемыйФайл = Ждать ПоместитьФайлНаСерверАсинх( , , , Новый ПараметрыДиалогаПомещенияФайлов); Если ПроверяемыйФайл = Неопределено Тогда Возврат Неопределено; КонецЕсли; ДанныеФайла = ПолучитьИзВременногоХранилища(ПроверяемыйФайл.Адрес); МенеджерКриптографии = Новый МенеджерКриптографии("", "", 80); ЭтоПрисоединеннаяПодпись = Ждать МенеджерКриптографии.ПроверитьНаличиеДанныхВПодписиАсинх(ДанныеФайла); Если ЭтоПрисоединеннаяПодпись Тогда Сертификат = Ждать МенеджерКриптографии.ПроверитьПодписьАсинх(ДанныеФайла); ПодписанныеДанные = Ждать МенеджерКриптографии.ПолучитьДанныеИзПодписиАсинх(ДанныеФайла); Иначе ПроверяемаяПодпись = Ждать ПоместитьФайлНаСерверАсинх( , , , ПроверяемыйФайл.СсылкаНаФайл.Файл.Путь + "signature.sign"); Если ПроверяемаяПодпись = Неопределено Тогда Возврат Неопределено; КонецЕсли; Подпись = ПолучитьИзВременногоХранилища(ПроверяемаяПодпись.Адрес); Сертификат = Ждать МенеджерКриптографии.ПроверитьПодписьАсинх(ДанныеФайла, Подпись); КонецЕсли; КонецФункции

23.5.8. Усовершенствование ЭЦП

Копировать в буфер обмена &НаКлиенте Асинх Процедура ВыполнитьКоманду(Команда) // Выбрать подписанный файл ПомещенныйФайл = Ждать ПоместитьФайлНаСерверАсинх( , , , Новый ПараметрыДиалогаПомещенияФайлов); Если ПомещенныйФайл = Неопределено Тогда Возврат; КонецЕсли; ИмяФайлаПодписи = СтрЗаменить(ПомещенныйФайл.СсылкаНаФайл.Файл.ПолноеИмя, ПомещенныйФайл.СсылкаНаФайл.Расширение, ".sign"); ИмяФайлаУсовершенствованнойПодписи = СтрЗаменить(ПомещенныйФайл.СсылкаНаФайл.Файл.ПолноеИмя, ПомещенныйФайл.СсылкаНаФайл.Расширение, ".extsign"); ПомещеннаяПодпись = Ждать ПоместитьФайлНаСерверАсинх( , , , ИмяФайлаПодписи); Если ПомещеннаяПодпись = Неопределено Тогда Возврат; КонецЕсли; Подпись = ПолучитьИзВременногоХранилища(ПомещеннаяПодпись.Адрес); МенеджерКриптографии = Новый МенеджерКриптографии("", "", 80); // Установим адреса серверов меток доверенного времени Адреса = Новый Массив; Адреса.Добавить("http://testca2012.cryptopro.ru/tsp/tsp.srf"); МенеджерКриптографии.АдресаСерверовМетокВремени = Адреса; // Усовершенствуем подпись файла Ждать МенеджерКриптографии.УсовершенствоватьПодписьАсинх(Подпись, ИмяФайлаУсовершенствованнойПодписи, ТипПодписиКриптографии.CAdESAv3); КонецПроцедуры

23.5.9. Добавление архивной метки времени

Функция выполняет проверку действительности ЭЦП для некоторого файла. Вначале выполняется проверка, что файл является файлом ЭЦП с включенными данными. Если на вход передан файл без присоединенной ЭЦП, то ожидается, что отсоединенная ЭЦП находится в файле с именем signature.sign. В этом случае предполагается, что файл ЭЦП находится в том же каталоге, что и подписанный файл. В переменную ПодписанныеДанные получается файл, который был подписан присоединенной ЭЦП. В примере эти данные никак не используются.

Функция выполняет усовершенствование отсоединенной ЭЦП, т. е. изменяет тип электронной подписи до типа, который содержит отметку доверенного времени. Считается, что подпись хранится в файле с тем же именем и расширением .sign. Усовершенствованная подпись будет сохраняться в файле с расширением .extsign. В данном примере предлагается выбрать не файл подписи, а подписанный файл. Имена файл подписи и файла усовершенствованной подписи функция сформирует самостоятельно.

В том случае, если подписанный документ находится в архиве, требуется периодически добавлять в подпись данного документа архивные метки времени. Функция демонстрирует данную операцию для всех файлов отсоединенной ЭЦП,

Копировать в буфер обмена &НаКлиенте Асинх Процедура ВыполнитьКоманду(Команда) МенеджерКриптографии = Новый МенеджерКриптографии("", "", 80); // Установим адреса серверов меток доверенного времени Адреса = Новый Массив; Адреса.Добавить("https://1stdss.1c.ru/TSP/tsp.srf"); МенеджерКриптографии.АдресаСерверовМетокВремени = Адреса; // Выберем все файлы подписи ИсходныйКаталог = "c:\temp\"; ФайлыПодписей = Ждать НайтиФайлыАсинх(ИсходныйКаталог, "*.sign", Ложь); Для каждого ФайлПодписи Из ФайлыПодписей Цикл НоваяПодпись = Ждать МенеджерКриптографии.ДобавитьАрхивнуюМеткуВремениАсинх(ФайлПодписи.ПолноеИмя); // запишем подпись обратно в файл Ждать НоваяПодпись.ЗаписатьАсинх(ФайлПодписи.ПолноеИмя); КонецЦикла; КонецПроцедуры

23.5.10. Получение информации о подписях

Копировать в буфер обмена &НаКлиенте Асинх Процедура ПолучитьИнформациюОПодписях(Команда) // Выбрать подписанный файл ПроверяемыйФайл = Ждать ПоместитьФайлНаСерверАсинх( , , , Новый ПараметрыДиалогаПомещенияФайлов); Если ПроверяемыйФайл = Неопределено Тогда Возврат; КонецЕсли; ДанныеФайла = ПолучитьИзВременногоХранилища(ПроверяемыйФайл.Адрес); МенеджерКриптографии = Новый МенеджерКриптографии("", "", 80); ЭтоПрисоединеннаяПодпись = Ждать МенеджерКриптографии.ПроверитьНаличиеДанныхВПодписиАсинх(ДанныеФайла); Если ЭтоПрисоединеннаяПодпись Тогда КонтейнерПодписей = Ждать МенеджерКриптографии.ПолучитьКонтейнерПодписейКриптографииАсинх(ДанныеФайла); Иначе ПроверяемаяПодпись = Ждать ПоместитьФайлНаСерверАсинх( , , , ПроверяемыйФайл.СсылкаНаФайл.Файл.Путь + "signature.sign"); Если ПроверяемаяПодпись = Неопределено Тогда Возврат; КонецЕсли; ДанныеПодписи = ПолучитьИзВременногоХранилища(ПроверяемаяПодпись.Адрес); КонтейнерПодписей = Ждать МенеджерКриптографии.ПолучитьКонтейнерПодписейКриптографииАсинх(ДанныеПодписи); КонецЕсли; Для каждого Подпись Из КонтейнерПодписей.Подписи Цикл Строка = ""; Строка = "Индекс: " + Подпись.Индекс; Строка = Строка + " Данные: " + ?(Подпись.Данные = Неопределено, "отсутствуют", "присутствуют"); Строка = Строка + " ТипПодписи: " + Подпись.ТипПодписи; Строка = Строка + " АлгоритмХеширования: " + Подпись.АлгоритмХеширования; Строка = Строка + " АлгоритмПодписи: " + Подпись.АлгоритмПодписи; Сообщить(Строка); КонецЦикла; КонецПроцедуры

23.6. Асинхронная работа с механизмом криптографии

Копировать в буфер обмена &НаКлиенте Асинх Процедура ПолучитьСписок(Команда) Криптография = Новый МенеджерКриптографии; Ждать Криптография.ИнициализироватьАсинх("", "", 80); ХранилищеСертификатов = Ждать

Файл ЭЦП с добавленной архивной меткой времени сохранятся в тот же самый файл.

В данном примере рассматривается получение информации о подписях, которыми подписан файл. В примере происходит автоматическое определение типа подписи. Для отсоединенной подписи используется алгоритм хранения подписи, который описан в примере формирования (и проверки) ЭЦП.

Использование асинхронной схемы работы с криптографией имеет ряд особенностей:

•

Она доступна только на стороне клиентского приложения. На стороне сервера следует использовать синхронный способ работы.

•

Для использования криптографии в веб-клиенте необходимо предварительно установить расширение работы с криптографией.

Рассмотрим пример работы с криптографической функциональностью в асинхронном режиме. В качестве примера будет рассмотрен процесс получения списка сертификатов из определенного типа хранилища сертификатов.

ПРИМЕЧАНИЕ. Пример, приведенный ниже, не является законченным. Он предназначен для демонстрации асинхронной работы со средствами криптографии.

Сообщить("Серийный номер сертификата = " + Сертификат.СерийныйНомер); КонецЦикла; КонецПроцедуры

Данный пример полностью иллюстрирует особенности работы с криптографией в асинхронном режиме. В примере видно, что собственно код на встроенном языке практически не отличается от аналогичного кода, который использовался в синхронной схеме работы.