Глава 32. Внешние компоненты

32.1. Общая информация

Система «1С:Предприятие» является расширяемой системой. Для расширения функциональных возможностей используются внешние компоненты.

В системе используются две технологии создания внешних компонент:

•

с использованием Native API,

•

с использованием технологии COM.

Это позволяет создавать внешние компоненты для:

•

ОС семейства Linux, macOS и семейства Windows.

•

Веб-клиента, работающего в веб-браузерах Google Chrome, Microsoft Internet Explorer, Mozilla Firefox и Safari.

•

Мобильного приложения, работающего под управлением мобильных ОС Android, iOS и Windows.

Внешние компоненты, предназначенные для работы в среде веб-клиента или мобильного приложения, должны быть упакованы в zip-архив особой структуры. Такой файл можно использовать также на сервере «1С:Предприятия» и в других клиентах.

При подключении внешней компоненты можно указать тип подключения внешней компоненты (параметр ТипПодключения метода ПодключитьВнешнююКомпоненту()). Этот параметр указывает, как будет загружаться и использоваться внешняя компонента. Данный параметр принимает значение типа ТипПодключенияВнешнейКомпоненты (системное перечисление). Система поддерживает следующие типы подключения:

•

НеИзолированно ‑ в этом случае внешняя компонента будет загружаться (и выполняться) в тот же процесс операционной системы, который выполняет код встроенного языка. При таком подключении, аварийное завершение внешней компоненты приведет к аварийному завершению и всего процесса, который использует эту внешнюю компоненту. Аварийное завершение процесса, использующего внешнюю компоненту, означает то, что аварийно будут завершены и все сеансы, которые обслуживает завершившийся процесс. В документации будем называть такой режим подключения не изолированным.

•

Изолированно ‑ в этом случае внешняя компонента загружается в отдельных процесс операционной системы, который не связан с процессом, в котором исполняется встроенный язык. Такой процесс будет называться хост-процессом. В том случае, если внешняя компонента, работающая в хост-процессе, завершится аварийно, то процесс встроенного языка (клиентский сеанс) не пострадает, а аварийно завершится только сам хост-процесс. В документации будем называть такой режим подключения изолированным.

Если внешняя компонента подключается изолированно, то создается хост-процесс. Если хост-процесс создать не удалось (например, по причине отсутствия прав на создание отдельного процесса), то внешняя компонента будет подключено не изолированно. Таким образом, работоспособность системы будет сохранена. Однако, если внешняя компонента не поддерживает не изолированное подключение, то внешняя компонента не будет подключена, и работа будет невозможна.

Чтобы внешняя компонента могла работать в хост-процессе, эту внешнюю компоненту необходимо написать (или доработать) с учетом некоторых особенностей, изложенных в описании технологии внешних компонент (на портале ИТС). Также следует помнить, что подключение внешней компоненты с указанием только идентификатора объекта (метод ПодключитьВнешнююКомпоненту() с одним параметром) ‑ всегда подключает внешнюю компоненту не изолированно.

Успешность подключения внешней компоненты (в общем случае) зависит от двух факторов: поддерживаемые типы подключения самой внешней компоненты, а если тип подключения не указан, то и от текущего режима совместимости конфигурации:

•

Если в конфигурации установлен режим совместимости с версией 8.3.20 или какой-либо предыдущей версии ‑ внешняя компонента будет подключаться не изолированно.

•

В противном случае внешняя компонента будет подключаться:

•

на клиенте ‑ не изолированно,

•

на сервере ‑ изолированно.

•

Если внешняя компонента поддерживает тип подключения, то подключение будет выполнено, в противном случае будет сформировано исключение. Например, у конфигурации установлен режим совместимости с версией 8.3.19, внешняя компонента поддерживает только изолированный режим подключения и метод ПодключитьВнешнююКомпоненту() вызывается без указания типа подключения. В этом случае будет сформировано исключение (и внешняя компонента не будет подключена).

В конфигурации также необходимо предпринять ряд действий, чтобы корректно обрабатывать возможные аварийные завершения внешних компонент, работающих в хост-процессах. Для обработки аварийного завершения внешней компоненты предназначены обработчики событий:

•

ОбработкаОтключенияВнешнейКомпонентыПриОшибке() в модуле приложения.

•

ОтключениеВнешнейКомпонентыПриОшибке() в модуле формы.

Управление передается этим обработчикам после того, как произошло аварийное завершение внешней компоненты и после того, как завершилось исполнение встроенного языка. В обработчике события можно проанализировать, какая внешняя компонента завершилась и выполнить повторное подключение и инициализацию этой внешней компоненты. Следует учитывать следующую особенность: если подключение и инициализация изолированной внешней компоненты выполняется на сервере, то аварийное завершение внешней компоненты не может быть обработано на сервере. В этом случае обработка аварийной ситуации возможна только на клиенте, с помощью вышеописанных обработчиков событий.

Если используется компонента, упакованная в zip-архив, то для указания параметров внешней компоненты (имя устанавливаемого файла, тип, архитектура, используемый веб-браузера) служит специальный файл-манифест, формируемый разработчиком компоненты. Получаемые из конфигурации или информационной базы внешние компоненты сохраняются после получения и используются при последующем подключении (с помощью методов УстановитьВнешнююКомпоненту(), ПодключитьВнешнююКомпоненту() или ПодключитьВнешнююКомпонентуАсинх()) без повторного получения (компонента, используемая на сервере, сохраняется только на время работы рабочего процесса сервера) ‑ выполняется кеширование внешней компоненты. Для компонент, которые были подключены из данных в информационной базе, будет отслеживаться изменение данных. Проверка выполняется при подключении компоненты, но не чаще 1 раза в секунду. Если данные были изменены с момента последнего подключения компоненты, то для этой компоненты будет очищен кеш внешних компонент. В результате, при следующем подключении компоненты, компонента будет извлечена из данных заново. Для объектов метаданных, не имеющих версии записи, очистка кеша будет осуществляться при обращении за данными, но не чаще 1 раза в секунду.

При работе с компонентами, написанными с использованием Native API, следует придерживаться следующей схемы работы:

•

В интерфейсе реализуется команда, которая вызывает установку внешней компоненты на компьютер пользователя (метод глобального контекста УстановитьВнешнююКомпоненту()). Данная операция обязательная для работы в тонком и веб-клиентах.

•

Компонента подключается с помощью метода ПодключитьВнешнююКомпоненту(). При этом следует помнить, что попытка подключить неустановленную компоненту приведет к ошибке.

•

Создать объект внешней компоненты с помощью конструктора типа (оператор Новый()), где в качестве имени выступает строковый идентификатор, сформированный по некоторым правилам.

•

Подключенная компонента используется согласно предоставленному программному интерфейсу.

32.2. Особенности работы в тонком и толстом клиентах

32.3. Особенности работы в веб-клиенте

подключить обработчик, который вызывается при аварийном завершении внешней компоненты.

СОВЕТ. Не следует объединять в один программный код установку и подключение внешней компоненты. Установка считается однократным событием, и повторная установка вызовет интерактивное исключение.

Примечание. Подключение внешних компонент, выполненных по технологии СОМ, с помощью методов ЗагрузитьВнешнююКомпоненту(), ПодключитьВнешнююКомпоненту(), а также регистрация объектов компоненты выполняются «для пользователя». Если регистрация «для пользователя» завершилась неудачно, то предпринимается попытка выполнить регистрацию «для компьютера».

Если внешняя компонента подключается с помощью метода ПодключитьВнешнююКомпоненту(), то формирование параметра в операторе Новый() (имя создаваемого типа) выполняется из следующих частей:

•

Текст Addin.;

•

Имя, указанное в качестве параметра Имя метода ПодключитьВнешнююКомпоненту();

•

Имя объекта, реализованного во внешней компоненте.

Если во внешней компоненте реализован объект Таймер и подключение внешней компоненты выполняется следующим образом: ПодключитьВнешнююКомпоненту(НавСсылка, "MyName");, то для создания объекта из внешней компоненты, следует указать следующий идентификатор: Новый("Addin.MyName.Таймер").

Смотри также:

•

Описание технологии внешних компонент (http://its.1c.ru/db/metod8dev#content:3221:hdoc).

При работе в толстом и тонком клиентах можно использовать как внешние компоненты, разработанные по технологии COM, так и внешние компоненты, разработанные по технологии Native API (как отдельными файлами на диске, так и в zip-архивах особого вида).

Для обновления компоненты достаточно повторно выполнить операцию установки внешней компоненты с помощью метода УстановитьВнешнююКомпоненту().

В момент установки внешние компоненты устанавливаются в каталог %APPDATA%\1C\1Cv8\ExtCompT. Каталог установки внешних компонент не считается кешем и не очищается при вызове «1С:Предприятия» с ключом командной строки /ClearCache. Использование метода УстановитьВнешнююКомпоненту() для тонкого клиента является обязательным.

При работе в веб-клиенте можно использовать компоненты, разработанные по технологии Native API или COM и упакованные в zip-архив особого вида. Компоненты, разработанные по технологии COM, можно использовать только в том случае, если веб-клиент работает в ОС семейства Windows. При установке файла внешней компоненты будет запрошено разрешение пользователя на установку расширения. При подключении внешней компоненты в веб-клиенте игнорируется значение параметра ТипПодключения метода ПодключитьВнешнююКомпоненту() и подключение выполняется в зависимости от веб-браузера:

•

Google Chrome ‑ изолированно;

•

Microsoft Internet Explorer ‑ не изолированнo;

•

Mozilla Firefox ‑ изолированно;

•

Safari ‑ не изолированно.

Копировать в буфер обмена Если Не ПодключитьВнешнююКомпоненту() Тогда УстановитьВнешнююКомпоненту() КонецЕсли;

веб-браузер. Описание особенностей настройки веб-браузеров см. здесь.

Каждая внешняя компонента устанавливается в виде отдельного расширения веб-браузера. Такое расширение представляет собой установочный пакет, подготовленный специальным образом для конкретного вида браузеров. Установка внешних компонент выполняется в следующие места (в зависимости от веб-браузера):

•

Google Chrome ‑ в каталог профиля текущего пользователя веб-браузера (создается веб-браузером);

•

Microsoft Internet Explorer ‑ в каталог %ALLUSERSPROFILE%\Application Data\1C\1CEWebExt (%ALLUSERSPROFILE%\1C\1CEWebExt для ОС Windows Vista и выше);

•

Mozilla Firefox ‑ в каталог профиля текущего пользователя веб-браузера (создается веб-браузером);

•

Safari ‑ определяется разработчиком внешней компоненты.

Удаление внешних компонент выполняется следующим образом (в зависимости от веб-браузера):

•

Google Chrome ‑ через механизм работы с расширениями веб-браузера;

•

Microsoft Internet Explorer ‑ через механизм установки/удаления программ панели управления;

•

Mozilla Firefox ‑ через механизм работы с дополнениями веб-браузера;

•

Safari ‑ стандартным способом.

ВНИМАНИЕ! Подключение внешних компонент из файла на диске для веб-клиента в целях безопасности не поддерживается.

Также следует помнить, что работа с COM-объектами доступна только в веб-браузере Microsoft Internet Explorer и ОС Windows. Также отсутствует поддержка типа COMSafeArray и возможность совершать вызовы методов COM-объектов, которые работают со значениями данного типа.

Для обновления компоненты необходимо выполнить одну из следующих операций:

•

удалить компоненту, как указано выше, и заново выполнить установку с помощью метода УстановитьВнешнююКомпоненту();

•

изменить имя объекта компоненты в исходном тексте компоненты и в файле манифеста (при этом имя файла с компонентой может не меняться) и заново выполнить установку с помощью метода УстановитьВнешнююКомпоненту().

При использовании внешних компонент в конфигурации следует придерживаться определенных правил и рекомендаций. Выполнение этих правил необходимо для того, чтобы внешние компоненты устанавливались без проблем на всех поддерживаемых веб-браузерах.

•

Исключить использование конструкций вида:

•

Установка внешней компоненты или расширений платформы (расширение работы с файлами, расширение работы с криптографией) должна быть интерактивной. Пользователь прикладного решения должен самостоятельно принять решение об установке. В диалоге установки должно быть сказано, для чего нужна компонента и что не будет работать, если ее не устанавливать.

•

Рекомендуется интегрировать установку внешней компоненты в процесс выполнения прикладного действия. Например:

1. Пользователь воспользовался командой Отправить отчет.

2. Для этого прикладному решению необходимо, чтобы была установлена какая-либо внешняя компонента.

32.4. Особенности работы на сервере

32.5. Особенности использования в мобильном приложении

32.6. Асинхронная работа с внешней компонентой

32.6.1. Через обратный вызов

4. Если внешняя компонента не установлена, пользователю отображается диалоговое окно, содержащую информацию о том, что для отправки отчета нужно установить компоненту и две кнопки: для установки внешней компоненты и для продолжения отправки отчета.

5. Затем пользователь последовательно выполняет два интерактивных действия:

6. Установку внешней компоненты;

7. Продолжение отправки отчета.

•

В прикладном решении должны быть реализованы инструменты для установки пользователем внешних компонент и расширений платформы в любой момент работы. Действия по установке внешних компонент и расширений платформы не обязательно должны выполняться в процессе выполнения какого-либо действия.

При работе на сервере «1С:Предприятия» допустимо использовать только компоненты, разработанные по технологии Native API, которые могут быть как отдельными файлами, так и упакованными в специальные zip-архивы.

Для подключения внешней компоненты используется метод ПодключитьВнешнююКомпоненту() (без использования метода УстановитьВнешнююКомпоненту(), который недоступен на сервере).

При работе на сервере желательно выполнять подключение внешней компоненты непосредственно перед ее использованием. Кроме того, компоненты, используемые на сервере, должны поддерживать все архитектуры и платформы. Это связано с тем, что в общем случае серверный код может исполняться на разных рабочих процессах (в разные моменты времени), которые могут исполняться на разных компьютерах. При этом компьютеры могут быть как разной архитектуры, так и функционировать под управлением различных операционных систем.

Файл внешней компоненты сохраняется рабочим процессом до своего перезапуска, поэтому повторное подключение внешней компоненты (до перезапуска рабочего процесса или переключения исполнения на другой рабочий процесс) происходит быстрее, чем первое подключение.

Если на внешняя компонента подключается в изолированном режиме, то аварийное завершение работы внешней компоненты приводит к тому, что серверный вызов завершается и управление возвращается на сторону клиента, где срабатывает обработчик оповещения об ошибке во внешней компоненте.

Смотри также:

•

Общая информация о работе с внешними компонентами (см. здесь).

В мобильном приложении допускается использовать только компоненты, разработанные по технологии Native API, которые могут быть как отдельными файлами, так и упакованными в zip-архивы особого вида.

Более подробно особенности использования внешних компонент в мобильном приложении см. здесь.

Применение внешних компонент в асинхронном режиме (с использованием обратного вызова) имеет ряд особенностей:

•

Подключение внешней компоненты выполняется с помощью асинхронного метода НачатьПодключениеВнешнейКомпоненты().

32.6.2. Через обещания

НачатьУстановку<ИмяСвойства>() и НачатьПолучение<ИмяСвойства>().

•

Вместо обращения к методу компоненты следует использовать асинхронные методы НачатьВызов<ИмяМетода>().

Методы Начать…() автоматически добавляются платформой к существующим свойствам и методам внешней компоненты. Саму внешнюю компоненту не требуется отдельно перерабатывать для поддержки работы в асинхронном режиме, однако необходимо выполнить перекомпиляцию существующей внешней компоненты для поддержки асинхронной работы.

Для метода НачатьВызов…() первым параметров следует указывать описание оповещения, а остальные параметры соответствуют набору параметров оригинального метода внешней компоненты.

При использовании веб-браузеров Google Chrome и Mozilla Firefox поддерживается только асинхронное подключение и использование внешних компонент, в том время как для других веб-браузеров допустимо использование как синхронного, так и асинхронного способа работы. Это определяется свойством конфигурации Режим использования синхронных вызовов расширений платформы и внешних компонент (см. здесь).

Смотри также:

•

Асинхронная работа через обратный вызов (см. здесь).

Применение внешних компонент в асинхронном режиме (с помощью обещаний) имеет ряд особенностей:

•

Установка внешней компоненты выполняется с помощью асинхронной функции УстановитьВнешнююКомпонентуАсинх().

•

Подключение внешней компоненты выполняется с помощью асинхронного метода ПодключитьВнешнююКомпонентуАсинх().

•

Для создания объекта внешней компоненты следует использовать метод глобального контекста СоздатьОбъектВнешнейКомпонентыАсинх(). Имя типа формируется точно так, как и для для конструктора Новый() (см. здесь).

•

Для обращения к свойствам внешней компоненты следует использовать асинхронные методы Получить<ИмяСвойства>Асинх() и Установить<ИмяСвойства>Асинх().

•

Вместо обращения к методу компоненты следует использовать асинхронные методы вида <ИмяМетода>Асинх().

Все асинхронные методы автоматически добавляются к фактическому интерфейсу внешней компоненты. Саму внешнюю компоненту не требуется отдельно перерабатывать для поддержки работы в асинхронном режиме, однако необходимо выполнить перекомпиляцию существующей внешней компоненты для поддержки асинхронной работы.

Результатом ожидания обещания, которое возвращает метод <ИмяМетода>Асинх(), будет значение специального типа РезультатАсинхВызоваВнешнейКомпоненты. Значение этого типа будет содержать результат работы внешней компоненты (в свойстве РезультатАсинхВызоваВнешнейКомпоненты.Значение) и все параметры внешней компоненты (в том числе и измененные во время вызова метода). Эти параметры будут расположены в свойстве РезультатАсинхВызоваВнешнейКомпоненты.Параметры.

При использовании веб-браузеров Google Chrome и Mozilla Firefox поддерживается только асинхронное подключение и использование внешних компонент, в том время как для других веб-браузеров допустимо использование как синхронного, так и асинхронного способа работы. Это определяется свойством конфигурации Режим использования синхронных вызовов расширений платформы и внешних компонент (см. здесь).

Смотри также:

32.7. Примеры работы с внешней компонентой

32.7.1. Технология Native API

32.7.1.1. Установка внешней компоненты на клиента

Копировать в буфер обмена УстановитьВнешнююКомпоненту("ОбщийМакет.ДрайверСканераШтрихкодов");

32.7.1.2. Загрузка из файла на диске

Копировать в буфер обмена СисИнфо = Новый СистемнаяИнформация; Если СисИнфо.ТипПлатформы = ТипПлатформы.Windows_x86 Тогда ПодключитьВнешнююКомпоненту("AddInCPP.dll", "MyName", ТипВнешнейКомпоненты.Native); ИначеЕсли СисИнфо.ТипПлатформы = ТипПлатформы.Windows_x86_64 Тогда ПодключитьВнешнююКомпоненту("AddInCPP64.dll", "MyName", ТипВнешнейКомпоненты.Native); ИначеЕсли СисИнфо.ТипПлатформы = ТипПлатформы.Linux_x86 Тогда ПодключитьВнешнююКомпоненту("libAddInCPP.so", "MyName", ТипВнешнейКомпоненты.Native); Иначе ПодключитьВнешнююКомпоненту("libAddInCPP64.so", "MyName", ТипВнешнейКомпоненты.Native); КонецЕсли; ОбъектКомпоненты = Новый("AddIn.MyName.ComponentExtension");

32.7.1.3. Загрузка компоненты из макета

Копировать в буфер обмена СисИнфо = Новый СистемнаяИнформация; Если СисИнфо.ТипПлатформы = ТипПлатформы.Windows_x86 Тогда ПодключитьВнешнююКомпоненту("Обработка.Компонента.Макет.AddInWindows32", "MyName", ТипВнешнейКомпоненты.Native); ИначеЕсли СисИнфо.ТипПлатформы = ТипПлатформы.Windows_x86_64 Тогда ПодключитьВнешнююКомпоненту("Обработка.Компонента.Макет.AddInWindows64", "MyName", ТипВнешнейКомпоненты.Native); ИначеЕсли СисИнфо.ТипПлатформы = ТипПлатформы.Linux_x86 Тогда ПодключитьВнешнююКомпоненту("Обработка.Компонента.Макет.AddInLinux32", "MyName", ТипВнешнейКомпоненты.Native); Иначе ПодключитьВнешнююКомпоненту("Обработка.Компонента.Макет.AddInLinux64", "MyName", ТипВнешнейКомпоненты.Native); КонецЕсли; ОбъектКомпоненты = Новый("AddIn.MyName.ComponentExtension");

32.7.1.4. Загрузка из информационной базы

Внешние компоненты, выполненные по технологии Native API, можно подключать не только в клиентских приложениях, но и на сервере приложений «1С:Предприятия».

При работе компоненты на сервере вызов ПодключитьВнешнююКомпоненту() необходимо выполнять каждый раз перед созданием экземпляра внешней компоненты, т. к. в общем случае неизвестно, на каком сервере будет исполняться вызов (это может быть Windows, Linux, 32-разрядная или 64-разрядная ОС).

Файл внешней компоненты должен находиться на компьютере пользователя и быть доступен в пути поиска (переменная окружения PATH) операционной системы.

ПРИМЕЧАНИЕ. Следует обратить внимание на формирование параметра в команде Новый.

ПРИМЕЧАНИЕ. Следует обратить внимание на формирование параметра в команде Новый.

В информационной базе должен быть справочник ВнешниеКомпоненты и реквизиты для указанных названий с типом ХранилищеЗначения с файлами внешних компонент.

СисИнфо = Новый СистемнаяИнформация; Если СисИнфо.ТипПлатформы = ТипПлатформы.Windows_x86 Тогда Ссылка = ПолучитьНавигационнуюСсылку(Справочники.ВнешниеКомпоненты.НайтиПоКоду("000000001"), "КомпонентаWindows32"); ИначеЕсли СисИнфо.ТипПлатформы = ТипПлатформы.Windows_x86_64 Тогда Ссылка = ПолучитьНавигационнуюСсылку(Справочники.ВнешниеКомпоненты.НайтиПоКоду("000000001"), "КомпонентаWindows64"); ИначеЕсли СисИнфо.ТипПлатформы = ТипПлатформы.Linux_x86 Тогда Ссылка = ПолучитьНавигационнуюСсылку(Справочники.ВнешниеКомпоненты.НайтиПоКоду("000000001"), "КомпонентаLinux32"); Иначе Ссылка = ПолучитьНавигационнуюСсылку(Справочники.ВнешниеКомпоненты.НайтиПоКоду("000000001"), "КомпонентаLinux64"); КонецЕсли; ПодключитьВнешнююКомпоненту(Ссылка, "MyName", ТипВнешнейКомпоненты.Native); ОбъектКомпоненты = Новый("AddIn.MyName.ComponentExtension");

32.7.1.5. Подключить компоненту из zip-архива

Копировать в буфер обмена ПодключитьВнешнююКомпоненту("ОбщийМакет.ДрайверСканераШтрихкодов", "Сканер"); Компонента = Новый("AddIn.Сканер.BarcodeReader");

32.7.1.6. Подключить внешнюю компоненту изолированно

Копировать в буфер обмена ПодключитьВнешнююКомпоненту("ОбщийМакет.ВнешняяКомпонента", "ВК", , ТипПодключенияВнешнейКомпоненты.Изолированно); Компонента = Новый("AddIn.ВК.BarcodeReader");

32.7.2. COM-технология

32.7.2.1. Загрузить внешнюю компоненту

Копировать в буфер обмена ЗагрузитьВнешнююКомпоненту("MyComponent.dll"); Компонента = Новый("AddIn.ComponentExtension");

32.7.2.2. Подключить внешнюю компоненту

ПРИМЕЧАНИЕ. Следует обратить внимание на формирование параметра в команде Новый.

В рассмотренных примерах работы с внешними компонентами по технологии Native API также можно подключать внешние компоненты, реализованные с использованием технологии COM только для ОС Windows.

В конфигурации должен быть общий макет с именем ДрайверСканераШтрихКодов с типом ДвоичныеДанные. В макете находится zip-архив особой структуры, в котором содержатся внешние компоненты для всех поддерживаемых операционных систем, браузеров и архитектур процессоров.

ПРИМЕЧАНИЕ. Следует обратить внимание на формирование параметра в команде Новый.

В конфигурации должен быть общий макет с именем ВнешняяКомпонента с типом ДвоичныеДанные. В макете находится zip-архив особой структуры, в котором содержатся внешние компоненты для всех поддерживаемых операционных систем, браузеров и архитектур процессоров. Внешняя компонента написана с учетом возможности изолированного подключения. Если внешняя компонента не поддерживает изолированное подключение ‑ будет сформировано исключение.

ПРИМЕЧАНИЕ. Следует обратить внимание на формирование параметра в команде Новый.

Компонента = Новый("AddIn.ComponentExtension");

ПРИМЕЧАНИЕ. Команда ЗагрузитьВнешнююКомпоненту() используется для совместимости с предыдущими версиями «1С:Предприятия».